---
title: "进程/线程 浏览器架构"
date: 2021-09-06T23:25:39+08:00
draft: false
tags:
 - 浏览器
---

PS : 笔记 From GeekTime `浏览器工作原理`
## 并行处理
计算机中的并行处理就是`同一时刻处理多个任务`

```js
A = 1+2
B = 20/5
C = 7*8
```
在编写代码的时候，我们可以把这个过程拆分为四个任务：
- 任务 1 是计算 A=1+2；
- 任务 2 是计算 B=20/5；
- 任务 3 是计算 C=7*8；
- 任务 4 是显示最后计算的结果。

1. 正常情况下程序可以使用`单线程`来处理，也就是分四步按照顺序分别执行这四个任务。

2. 如果采用`多线程`,只需要分两步:
- 使用三个线程同时执行前三个任务
- 执行第四个显示任务

## 线程 (thread) VS 进程
进程是资源分配的最小单位，线程是`操作系统`能够进行运算`调度`的最小单位; 这样的表述太抽象,不容易让人理解

`线程是不能单独存在的，它是由进程来启动和管理的`

> 一个进程就是一个程序的运行实例

启动一个程序的时候，操作系统会为该程序创建一块内存，用来存放`代码`、`运行中的数据`和`一个执行任务的主线程`，我们把这样的一个运行环境叫进程。
![](https://gtd-imgs-md.oss-cn-beijing.aliyuncs.com/imgs/20210907000053.png#w70)

> 线程是依附于进程的，而进程中使用多线程并行处理能提升运算效率(性能)

## 线程和进程的关系
1. `进程中的任意一线程执行出错，都会导致整个进程的崩溃。`
2. `线程之间共享进程中的数据。`
3. `当一个进程关闭之后，操作系统会回收进程所占用的内存。`
4. `进程之间的内容相互隔离。`
![](https://gtd-imgs-md.oss-cn-beijing.aliyuncs.com/imgs/20210907000401.png#w70)

## 单进程浏览器时代
单进程浏览器是指浏览器的所有功能模块都是运行在同一个进程里,这些模块包含了网络、插件、JavaScript 运行环境、渲染引擎和页面等;2007 年之前，市面上浏览器都是单进程的.
![](https://gtd-imgs-md.oss-cn-beijing.aliyuncs.com/imgs/20210907001206.png#w70)

### 1. 不稳定
插件是最容易出问题的模块，并且还运行在浏览器进程之中，所以一个插件的意外崩溃会引起整个浏览器的崩溃。
### 2. 不流畅
1. 所有页面的渲染模块、JavaScript 执行环境以及插件都是运行在同一个线程中的，这就意味着同一时刻只能有一个模块可以执行。
2. `页面的内存泄漏`也是单进程浏览器变慢的一个重要原因。运行一个复杂点的页面再关闭页面，会存在内存不能完全回收的情况，这样导致的问题是使用时间越长，内存占用越高，浏览器会变得越慢。
### 3. 不安全
可以从插件和页面脚本两个方面来看.

## 早期多进程架构
![](https://gtd-imgs-md.oss-cn-beijing.aliyuncs.com/imgs/20210907002332.png#w70)

### 1.解决不稳定
由于进程是相互隔离的，所以当一个页面或者插件崩溃时，影响到的仅仅是当前的页面进程或者插件进程
### 2.解决不流畅
1. JavaScript 运行在渲染进程中的，所以即使 JavaScript 阻塞了渲染进程，影响到的也只是当前的渲染页面
2. 当关闭一个页面时，整个渲染进程也会被关闭，之后该进程所占用的内存都会被系统回收
### 3.解决安全问题
采用多进程架构的额外好处是可以使用`安全沙箱`，Chrome 把`插件进程`和`渲染进程`锁在沙箱里面, 这样即使在渲染进程或者插件进程里面执行了恶意程序，恶意程序也无法突破沙箱去获取系统权限。

## 当前多进程架构
![](https://gtd-imgs-md.oss-cn-beijing.aliyuncs.com/imgs/20210907002303.png#w70)
最新的 Chrome 浏览器包括：
- `1 个浏览器（Browser）主进程、`
- `1 个 GPU 进程、`
- `1 个网络（NetWork）进程、`
- `多个渲染进程`
- `多个插件进程`

仅仅打开了 1 个页面，为什么有 4 个进程？
- 因为打开 1 个页面至少需要 1 个网络进程、1 个浏览器进程、1 个 GPU 进程以及 1 个渲染进程，共 4 个；如果打开的页面有运行插件的话，还需要再加上 1 个插件进程。

多进程架构模型缺陷
1. `更高的资源占用。`因为每个进程都会包含公共基础结构的副本（如 JavaScript 运行环境），这就意味着浏览器会消耗更多的内存资源。
2. `更复杂的体系架构。`浏览器各模块之间耦合性高、扩展性差等问题，会导致现在的架构已经很难适应新的需求了。

## 未来面向服务的架构
Services Oriented Architecture，简称 SOA;
![](https://gtd-imgs-md.oss-cn-beijing.aliyuncs.com/imgs/20210907003042.png#w70)
原来的各种模块会被重构成独立的服务（Service），每个服务（Service）都可以在独立的进程中运行，访问服务（Service）必须使用定义好的接口，通过 IPC 来通信，从而构建一个更内聚、松耦合、易于维护和扩展的系统，更好实现 Chrome 简单、稳定、高速、安全的目标。

理解:以前是每个页面需要若干进程完成各自的工作，现在是将各个页面通用的功能（视频、网络、渲染等）发布为系统服务，页面在需要的时候与相应的服务通信完成需要的功能。这起码把进程间的耦合从页面中分离出去了.